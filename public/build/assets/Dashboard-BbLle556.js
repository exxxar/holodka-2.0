import{_ as g}from"./AuthenticatedLayout-DnEdCOpn.js";import{o as t,f as o,b as s,i as m,k,d as p,g as u,v,n as b,e as w,m as $,F as h,l as y,t as r,c as j,a as _,u as x,w as f,Z as q}from"./app-D6rUhn54.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{P as V}from"./Pagination-DpO_0Gy_.js";import"./ApplicationLogo-jQI-eQk2.js";const I={data(){return{link:null,form:{is_only_active:!1,group:null,max_post_count:30}}},computed:{user(){return window.user}},watch:{"form.group":{handler:function(n){if(this.form.group.indexOf("http")!==-1){let e=this.form.group.lastIndexOf("/")+1;this.form.group=this.form.group.substring(e)}},deep:!0}},mounted(){this.requestToken()},methods:{submit(){this.$store.dispatch("addWork",this.form).then(n=>{const e=new CustomEvent("jobs-reload-event");document.dispatchEvent(e)})},requestToken(){this.$store.dispatch("requestVKToken").then(n=>{this.link=n})}}},T={class:"form-floating mb-3"},C={key:0,class:"alert alert-light my-2"},O=["href"],P={class:"d-flex w-100 justify-center"},E={class:"form-check form-switch"},K={class:"form-check-label",for:"is-only-active-users"},B={key:1,class:"alert alert-info rounded-0 my-3"},N={class:"d-flex w-100 justify-center"},D=["disabled"];function F(n,e,l,i,a,d){return t(),o("form",{onSubmit:e[2]||(e[2]=w((...c)=>d.submit&&d.submit(...c),["prevent"])),class:"mb-2"},[s("div",T,[m(s("input",{type:"text",class:"form-control","onUpdate:modelValue":e[0]||(e[0]=c=>a.form.group=c),id:"floatingInput",placeholder:"name@example.com",required:""},null,512),[[k,a.form.group]]),e[3]||(e[3]=s("label",{for:"floatingInput"},"Группа",-1))]),d.user.is_active_token?u("",!0):(t(),o("div",C,[e[4]||(e[4]=p(" Ваш тоукен недействительный! Обновите его! ")),a.link?(t(),o("a",{key:0,class:"btn btn-success mt-2 w-100 rounded-0 p-3",href:a.link},"Получить токен",8,O)):u("",!0)])),s("div",P,[s("div",E,[m(s("input",{"onUpdate:modelValue":e[1]||(e[1]=c=>a.form.is_only_active=c),class:"form-check-input",type:"checkbox",role:"switch",id:"is-only-active-users"},null,512),[[v,a.form.is_only_active]]),s("label",K,[e[5]||(e[5]=p(" Собирать только активных пользователей: ")),s("span",{class:b({"fw-bold text-primary":a.form.is_only_active})},"вкл",2),e[6]||(e[6]=p(" / ")),s("span",{class:b({"fw-bold text-primary":!a.form.is_only_active})},"выкл",2)])])]),a.form.is_only_active?u("",!0):(t(),o("p",B," В группе будет обработано не более 30 тыс. пользователей ")),s("div",N,[s("button",{disabled:!d.user.is_active_token,class:"btn btn-primary rounded-0"},"Добавить задачу ",8,D)])],32)}const L=J(I,[["render",F]]),M={key:0,class:"row"},Q={class:"col-12"},z={class:"table"},S={scope:"row"},U={key:0},G={key:1},R={key:2},W={key:3},Z={key:0},A={key:1},H={key:0},X={key:1},Y=["onClick"],ss={key:1,class:"alert alert-light"},es={key:2,class:"row mb-3"},ts={class:"col-12"},os={data(){return{current_page:0,jobs:[],pagination:null}},computed:{...$(["getJobs","getJobsPaginateObject"])},mounted(){this.loadJobs(),document.addEventListener("jobs-reload-event",n=>{this.loadJobs()})},methods:{removeJob(n){this.$store.dispatch("removeJob",{id:n.id}).then(e=>{this.loadJobs()})},loadJobs(n=0){this.current_page=n,this.$store.dispatch("loadJobs",{page:this.current_page}).then(e=>{this.jobs=this.getJobs,this.pagination=this.getJobsPaginateObject})}}},ns=Object.assign(os,{__name:"JobsTable",setup(n){return(e,l)=>(t(),o(h,null,[e.jobs.length>0?(t(),o("div",M,[s("div",Q,[s("table",z,[l[0]||(l[0]=s("thead",null,[s("tr",null,[s("th",{scope:"col"},"#"),s("th",{scope:"col"},"Группа"),s("th",{scope:"col"},"Максимальный охват"),s("th",{scope:"col"},"Собрано пользователей"),s("th",{scope:"col"},"Статус"),s("th",{scope:"col"},"Время выполнения"),s("th",{scope:"col"},"Вариант сбора"),s("th",{scope:"col"},"Дата завершения"),s("th",{scope:"col"},"Дата добавления"),s("th",{scope:"col"},"Действие")])],-1)),s("tbody",null,[(t(!0),o(h,null,y(e.jobs,(i,a)=>(t(),o("tr",null,[s("th",S,r(a+1),1),s("td",null,r(i.group),1),s("td",null,r(i.is_only_active?i.max_post_count:"не ограничено"),1),s("td",null,r(i.result_count),1),s("td",null,[i.status===0?(t(),o("span",U,"Новый")):u("",!0),i.status===1?(t(),o("span",G,"В обработке")):u("",!0),i.status===2?(t(),o("span",R,"Завершено")):u("",!0),i.status===3?(t(),o("span",W,"Ошибка")):u("",!0)]),s("td",null,[i.time_execute?(t(),o("span",Z,r(i.time_execute)+" мин. ",1)):(t(),o("span",A,"Не рассчитано"))]),s("td",null,[i.is_only_active?(t(),o("span",H,"Только активные")):(t(),o("span",X,"Все"))]),s("td",null,r(i.completed_at||""),1),s("td",null,r(i.created_at),1),s("td",null,[s("button",{onClick:d=>e.removeJob(i),class:"btn btn-danger"},"Удалить",8,Y)])]))),256))])])])])):(t(),o("div",ss," Вы еще не добавили задачи в очередь! ")),e.jobs.length>0?(t(),o("div",es,[s("div",ts,[e.pagination?(t(),j(V,{key:0,onPagination_page:e.loadJobs,pagination:e.pagination},null,8,["onPagination_page","pagination"])):u("",!0)])])):u("",!0)],64))}}),is={class:"py-12"},ls={class:"max-w-7xl mx-auto sm:px-6 lg:px-8"},rs={class:"bg-white overflow-hidden shadow-sm sm:rounded-lg"},as={class:"row p-3"},us={class:"col-4"},ds={class:"card rounded-0"},cs={class:"card-body"},_s={key:0,class:"list-group rounded-0"},ps={class:"list-group-item"},hs={class:"list-group-item"},ms={class:"list-group-item"},bs={key:0},fs={key:1},ys={class:"list-group-item"},gs={key:0},ks={key:1},vs=["href"],ws={class:"alert alert-success mb-2 rounded-0"},$s={class:"col-8"},js={class:"row p-3"},xs={class:"col-12"},qs={class:"my-2 fw-bold d-flex justify-between"},Js={key:0,class:"spinner-border spinner-border-sm",role:"status"},Vs={key:1,style:{"font-size":"10px"},class:"text-gray-400"},Is={data(){return{link:null,company:null,queue_count:null,messages:[]}},mounted(){this.requestToken(),this.company=this.user.company||null,this.jobsInQueue(),pusher.subscribe("my-channel").bind("my-event",e=>{e.userId===this.user.id&&(this.messages.push(e),setTimeout(()=>{window.location.reload()},4e3),this.$notify({title:"Внимание!",text:"Ваше задание #"+e.jobId+" успешно выполнено!",type:"success"}))})},computed:{logo(){return window.logo},user(){return window.user}},methods:{fillVK(){this.$store.dispatch("fillVK").then(n=>{})},jobsInQueue(){this.$store.dispatch("jobsInQueue").then(n=>{this.queue_count=n.summary_jobs_in_queue||0})},storeCompany(){this.$store.dispatch("storeCompany",{company:this.company}).then(n=>{window.location.reload()})},requestToken(){this.$store.dispatch("requestVKToken",this.form).then(n=>{this.link=n})}}},Ks=Object.assign(Is,{__name:"Dashboard",setup(n){return(e,l)=>(t(),o(h,null,[_(x(q),{title:"Панель управления"}),_(g,null,{header:f(()=>l[0]||(l[0]=[s("h2",{class:"font-semibold text-xl text-gray-800 leading-tight"},"Панель управления",-1)])),default:f(()=>[s("div",is,[s("div",ls,[s("div",rs,[s("div",as,[s("div",us,[s("div",ds,[s("div",cs,[l[1]||(l[1]=s("h6",{class:"my-2 fw-bold"},"Профиль пользователя",-1)),e.user?(t(),o("ul",_s,[s("li",ps,r(e.user.name||"Без имени"),1),s("li",hs,r(e.user.email||"Без почты"),1),s("li",ms,[e.user.vk_access_token!=null&&e.user.is_active_token?(t(),o("p",bs,"Тоукен успешно установлен")):(t(),o("p",fs,"Тоукен не задан"))]),s("li",ys,[e.user.vk_token_expired_at!=null?(t(),o("p",gs,r(e.user.vk_token_expired_at),1)):(t(),o("p",ks,"Тоукен не задан"))])])):u("",!0),e.link&&e.user.company?(t(),o("a",{key:1,class:"btn btn-success mt-2 w-100 rounded-0 p-3",href:e.link},"Получить токен",8,vs)):u("",!0),l[2]||(l[2]=s("hr",{class:"my-2"},null,-1)),(t(!0),o(h,null,y(e.messages,i=>(t(),o("div",ws," Собраны данные по группе "+r(i.group)+" (#"+r(i.jobId)+") ",1))),256))])])]),s("div",$s,[_(L)])]),s("div",js,[s("div",xs,[s("h6",qs,[l[4]||(l[4]=p("Задачи в очереди ")),e.queue_count?(t(),o("span",Vs,r(e.queue_count)+" в глобальной очереди ("+r(e.queue_count/10*10+10)+" мин) ",1)):(t(),o("span",Js,l[3]||(l[3]=[s("span",{class:"visually-hidden"},"Loading...",-1)])))]),_(ns)])])])])])]),_:1})],64))}});export{Ks as default};
